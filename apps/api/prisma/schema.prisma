generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  SUPERADMIN
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  COD
  BANK_TRANSFER
  MOMO
  VNPAY
  STRIPE
  PAYPAL
}

model User {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  email    String @unique
  password String
  role     Role   @default(USER)

  // Profile fields
  firstName   String?
  lastName    String?
  phone       String?
  avatar      String?
  dateOfBirth DateTime?

  // Loyalty & Points
  loyaltyPoints     Int @default(0)
  totalPointsEarned Int @default(0)

  // Security fields
  lastLoginAt         DateTime?
  lastLoginIp         String?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Preferences
  emailVerified         Boolean @default(false)
  emailOptIn            Boolean @default(true)
  pushOptIn             Boolean @default(true)
  marketingConsent      Boolean @default(false)
  dataProcessingConsent Boolean @default(false)
  preferredLanguage     String  @default("vi")
  preferredCurrency     String  @default("VND")

  // Timestamps
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  orders              Order[]
  createdCategories   Category[]     @relation("CategoryCreator")
  updatedCategories   Category[]     @relation("CategoryUpdater")
  deletedCategories   Category[]     @relation("CategoryDeleter")
  createdProducts     Product[]      @relation("ProductCreator")
  updatedProducts     Product[]      @relation("ProductUpdater")
  deletedProducts     Product[]      @relation("ProductDeleter")
  createdOrders       Order[]        @relation("OrderCreator")
  updatedOrders       Order[]        @relation("OrderUpdater")
  deletedOrders       Order[]        @relation("OrderDeleter")
  orderHistoryChanges OrderHistory[] @relation("OrderHistoryUser") // NEW
  orderNotesCreated   OrderNote[]    @relation("OrderNoteCreator") // NEW
  couponUsages      CouponUsage[]    @relation("UserCouponUsages") // NEW Sprint 1.3
  returns           Return[]         @relation("UserReturns") // NEW Sprint 1.3
  approvedReturns   Return[]         @relation("ReturnApprover") // NEW Sprint 1.3
  createdMedia        Media[]        @relation("MediaCreator")
  createdFolders      MediaFolder[]  @relation("FolderCreator")
  carts               Cart?
  reviews             Review[]
  shippingAddresses   ShippingAddress[]
  notifications       Notification[]
  blogPosts           BlogPost[]
  blogComments        BlogComment[]
  verificationToken   VerificationToken?
  
  // Security & Audit Relations (Phase 3)
  loginHistory        LoginHistory[]
  securityEvents      SecurityEvent[]
  resolvedEvents      SecurityEvent[]   @relation("ResolvedEvents")
  activityLogs        ActivityLog[]
  blockedIPs          IPBlacklist[]
}

model Category {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  slug      String     @unique
  parentId  String?    @db.ObjectId
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  Category[] @relation("CategoryHierarchy")
  products  Product[]
  createdAt DateTime   @default(now())
  createdBy String?    @db.ObjectId
  creator   User?      @relation("CategoryCreator", fields: [createdBy], references: [id])
  updatedAt DateTime   @updatedAt
  updatedBy String?    @db.ObjectId
  updater   User?      @relation("CategoryUpdater", fields: [updatedBy], references: [id])
  deletedAt DateTime?
  deletedBy String?    @db.ObjectId
  deleter   User?      @relation("CategoryDeleter", fields: [deletedBy], references: [id])
}

model Product {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String @unique
  description String

  // Pricing & Inventory
  price    Float
  stock    Int   @default(0)
  reserved Int   @default(0) // Reserved for pending orders

  // Product Info
  brand  String?
  sku    String?  @unique
  tags   String[] @default([])
  images String[] @default([])

  // Status & Features
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Cached aggregates
  averageRating Float @default(0)
  reviewCount   Int   @default(0)

  // SEO fields
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[] @default([])
  ogImage        String?

  // Relations
  categoryId            String                 @db.ObjectId
  category              Category               @relation(fields: [categoryId], references: [id])
  orderItems            OrderItem[]
  cartItems             CartItem[]
  reviews               Review[]
  variants              ProductVariant[] // NEW: Product variants
  inventoryTransactions InventoryTransaction[] //NEW: Inventory tracking
  returnItems           ReturnItem[]     @relation("ProductReturnItems") // NEW Sprint 1.3

  // Timestamps
  createdAt DateTime  @default(now())
  createdBy String?   @db.ObjectId
  creator   User?     @relation("ProductCreator", fields: [createdBy], references: [id])
  updatedAt DateTime  @updatedAt
  updatedBy String?   @db.ObjectId
  updater   User?     @relation("ProductUpdater", fields: [updatedBy], references: [id])
  deletedAt DateTime?
  deletedBy String?   @db.ObjectId
  deleter   User?     @relation("ProductDeleter", fields: [deletedBy], references: [id])
}

enum InventoryTransactionType {
  PURCHASE // Stock in
  SALE // Stock out
  RETURN // Customer return
  ADJUSTMENT // Manual adjustment
  DAMAGE // Damaged goods
  RESERVED // Reserved for order
  RELEASED // Released reservation
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
}

enum ShipmentStatus {
  PREPARING
  READY_TO_SHIP
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED_DELIVERY
  RETURNED
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum ReturnStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum ReturnReason {
  DEFECTIVE
  WRONG_ITEM
  NOT_AS_DESCRIBED
  CHANGED_MIND
  OTHER
}

model ProductVariant {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Variant details
  sku        String @unique
  name       String // e.g. "Red - Large", "128GB"
  attributes Json // {color: "red", size: "L"} or {storage: "128GB"}

  // Pricing & Stock
  price    Float
  stock    Int     @default(0)
  reserved Int     @default(0)
  isActive Boolean @default(true)

  // Relations
  inventoryTransactions InventoryTransaction[]
  cartItems             CartItem[]             @relation("VariantCartItems")
  orderItems            OrderItem[]            @relation("VariantOrderItems")
  returnItems           ReturnItem[]     @relation("VariantReturnItems") // NEW Sprint 1.3

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InventoryTransaction {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Product/Variant
  productId String          @db.ObjectId
  product   Product         @relation(fields: [productId], references: [id])
  variantId String?         @db.ObjectId
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  // Transaction details
  type      InventoryTransactionType
  quantity  Int // Positive for in, negative for out
  reference String? // Order ID, PO number, etc.
  note      String?

  // Timestamps
  createdAt DateTime @default(now())
  createdBy String?  @db.ObjectId
}

model Order {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // Pricing breakdown
  subtotal       Float
  discountAmount Float @default(0)
  shippingFee    Float @default(0)
  tax            Float @default(0)
  totalAmount    Float

  // Status
  status OrderStatus @default(PENDING)

  // Payment & Shipping
  paymentMethod   PaymentMethod?
  shippingAddress Json? // Structured: {fullName, phone, address, city, country, postalCode, isDefault}

  // Relations
  items     OrderItem[]
  history   OrderHistory[] @relation("OrderHistoryEntries") // NEW: Status tracking
  notes     OrderNote[]    @relation("OrderNotes") // NEW: Internal notes  
  payments  Payment[]      @relation("OrderPayments") // NEW: Payment records
  shipments Shipment[]     @relation("OrderShipments") // NEW: Shipping tracking
  couponUsages CouponUsage[] @relation("OrderCouponUsages") // NEW Sprint 1.3
  returns      Return[]      @relation("OrderReturns") // NEW Sprint 1.3

  // Timestamps
  createdAt DateTime  @default(now())
  createdBy String?   @db.ObjectId
  creator   User?     @relation("OrderCreator", fields: [createdBy], references: [id])
  updatedAt DateTime  @updatedAt
  updatedBy String?   @db.ObjectId
  updater   User?     @relation("OrderUpdater", fields: [updatedBy], references: [id])
  deletedAt DateTime?
  deletedBy String?   @db.ObjectId
  deleter   User?     @relation("OrderDeleter", fields: [deletedBy], references: [id])
}

model OrderItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String  @db.ObjectId
  order     Order   @relation(fields: [orderId], references: [id])
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])

  // Variant support
  variantId String?         @db.ObjectId
  variant   ProductVariant? @relation("VariantOrderItems", fields: [variantId], references: [id])

  quantity Int
  price    Float // Price snapshot at time of order
}

// NEW: Order status change tracking
model OrderHistory {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  orderId String @db.ObjectId
  order   Order  @relation("OrderHistoryEntries", fields: [orderId], references: [id])

  fromStatus OrderStatus?
  toStatus   OrderStatus
  note       String?

  changedAt DateTime @default(now())
  changedBy String?  @db.ObjectId
  user      User?    @relation("OrderHistoryUser", fields: [changedBy], references: [id])

  @@index([orderId, changedAt])
}

// NEW: Internal order notes
model OrderNote {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  orderId String @db.ObjectId
  order   Order  @relation("OrderNotes", fields: [orderId], references: [id])

  note       String
  isInternal Boolean @default(true) // Internal vs customer-visible

  createdAt DateTime @default(now())
  createdBy String   @db.ObjectId
  user      User     @relation("OrderNoteCreator", fields: [createdBy], references: [id])
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

// NEW: Payment transactions
model Payment {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  orderId String @db.ObjectId
  order   Order  @relation("OrderPayments", fields: [orderId], references: [id])

  amount   Float
  currency String        @default("VND")
  method   PaymentMethod
  status   PaymentStatus @default(PENDING)

  // Gateway info
  gatewayTransactionId String? // External payment gateway ID
  gatewayResponse      Json? // Full response from gateway

  // Refund tracking
  refundedAmount Float     @default(0)
  refundedAt     DateTime?
  refundReason   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([gatewayTransactionId])
}

// NEW: Shipment tracking  
model Shipment {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  orderId String @db.ObjectId
  order   Order  @relation("OrderShipments", fields: [orderId], references: [id])

  carrier        String // Giao Hàng Nhanh, Giao Hàng Tiết Kiệm, etc.
  trackingNumber String?
  status         ShipmentStatus @default(PREPARING)

  // Shipping details
  shippingAddress   Json // Same structure as Order.shippingAddress
  estimatedDelivery DateTime?
  actualDelivery    DateTime?

  // Tracking history
  trackingHistory Json[] @default([]) // [{status, timestamp, location, note}]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([trackingNumber])
}

// Coupon/Promotion system
model Coupon {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  code           String      @unique
  type           CouponType
  value          Float
  minOrderAmount Float?
  maxDiscount    Float?
  usageLimit     Int?
  usageCount     Int         @default(0)
  perUserLimit   Int?
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean     @default(true)
  
  usages CouponUsage[]
  
  createdAt DateTime  @default(now())
  createdBy String?   @db.ObjectId
  updatedAt DateTime  @updatedAt
}

model CouponUsage {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  couponId       String   @db.ObjectId
  coupon         Coupon   @relation(fields: [couponId], references: [id])
  userId         String   @db.ObjectId
  user           User     @relation("UserCouponUsages", fields: [userId], references: [id])
  orderId        String   @db.ObjectId
  order          Order    @relation("OrderCouponUsages", fields: [orderId], references: [id])
  
  discountAmount Float
  usedAt         DateTime @default(now())
  
  @@index([couponId, userId])
}

// Return/Refund system
model Return {
  id     String       @id @default(auto()) @map("_id") @db.ObjectId
  orderId String      @db.ObjectId
  order   Order       @relation("OrderReturns", fields: [orderId], references: [id])
  userId  String      @db.ObjectId
  user    User        @relation("UserReturns", fields: [userId], references: [id])
  
  status ReturnStatus @default(PENDING)
  reason ReturnReason
  note   String?
  
  items ReturnItem[]
  
  totalRefund Float
  
  approvedAt DateTime?
  approvedBy String?   @db.ObjectId
  approver   User?     @relation("ReturnApprover", fields: [approvedBy], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([orderId, userId])
}

model ReturnItem {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  returnId String @db.ObjectId
  return   Return @relation(fields: [returnId], references: [id])
  
  productId String  @db.ObjectId
  product   Product @relation("ProductReturnItems", fields: [productId], references: [id])
  
  variantId String?         @db.ObjectId
  variant   ProductVariant? @relation("VariantReturnItems", fields: [variantId], references: [id])
  
  quantity     Int
  refundAmount Float
  reason       String?
}

model MediaFolder {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  parentId  String?       @db.ObjectId
  parent    MediaFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  MediaFolder[] @relation("FolderHierarchy")
  media     Media[]
  createdAt DateTime      @default(now())
  createdBy String?       @db.ObjectId
  creator   User?         @relation("FolderCreator", fields: [createdBy], references: [id])
}

model Media {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  fileName String
  fileType String // MIME type: image/jpeg, video/mp4, etc.
  fileSize Int // Size in bytes
  fileUrl  String

  // Metadata
  altText String? // SEO alt text
  title   String? // Image title
  caption String? // Description/caption
  tags    String[] @default([]) // Searchable tags

  // Dimensions (for images/videos)
  width    Int?
  height   Int?
  duration Int? // Video duration in seconds

  // Relations
  folderId String?      @db.ObjectId
  folder   MediaFolder? @relation(fields: [folderId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  createdBy String?  @db.ObjectId
  creator   User?    @relation("MediaCreator", fields: [createdBy], references: [id])
  updatedAt DateTime @updatedAt
}

model Cart {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  userId    String     @unique @db.ObjectId
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  cartId    String  @db.ObjectId
  cart      Cart    @relation(fields: [cartId], references: [id])
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])

  // Variant support
  variantId String?         @db.ObjectId
  variant   ProductVariant? @relation("VariantCartItems", fields: [variantId], references: [id])

  quantity Int
}

model Review {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  rating  Int // 1-5 stars
  comment String?
  images  String[] @default([]) // Review photos

  // Verification & Moderation
  verified    Boolean      @default(false) // Purchase verified
  status      ReviewStatus @default(PENDING)
  isModerated Boolean      @default(false)
  reportCount Int          @default(0)

  // Helpfulness votes
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)

  // Relations
  userId    String  @db.ObjectId
  user      User    @relation(fields: [userId], references: [id])
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// User Shipping Addresses
model ShippingAddress {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  userId       String  @db.ObjectId
  user         User    @relation(fields: [userId], references: [id])
  fullName     String
  phoneNumber  String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String?
  country      String
  isDefault    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// System Notifications
model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  type      String   // e.g. "ORDER_STATUS", "PROMOTION", "SYSTEM"
  title     String
  message   String
  data      Json?    // Extra data like { orderId: "..." }
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())
}

// Email/Phone Verification Tokens
model VerificationToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  type      String   // "EMAIL_VERIFICATION", "PASSWORD_RESET"
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Blog System
enum BlogPostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model BlogCategory {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  // SEO
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[] @default([])

  // Relations
  posts     BlogPost[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  slug        String         @unique
  excerpt     String?
  content     String         // HTML or JSON content
  coverImage  String?
  status      BlogPostStatus @default(DRAFT)
  publishedAt DateTime?
  
  // SEO
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[] @default([])

  // Author
  authorId String @db.ObjectId
  author   User   @relation(fields: [authorId], references: [id])

  // Relations
  categoryId String       @db.ObjectId
  category   BlogCategory @relation(fields: [categoryId], references: [id])
  comments   BlogComment[]

  // Stats
  viewCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogComment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  isApproved Boolean @default(true) // Auto-approve by default, change if robust moderation needed

  // Relations
  postId    String   @db.ObjectId
  post      BlogPost @relation(fields: [postId], references: [id])
  userId    String?  @db.ObjectId // Optional: allow guest comments? For now, let's assume registered users or store generic name if guest
  user      User?    @relation(fields: [userId], references: [id])
  
  // Guest info (if userId is null)
  guestName  String?
  guestEmail String?

  parentId  String?       @db.ObjectId
  parent    BlogComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies   BlogComment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// CMS Pages System
enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum MenuLocation {
  HEADER
  FOOTER
  SIDEBAR
  MOBILE
}

model Page {
  id      String     @id @default(auto()) @map("_id") @db.ObjectId
  title   String
  slug    String     @unique
  content String     // JSON or HTML content
  excerpt String?    // Short description
  status  PageStatus @default(DRAFT)

  // Template
  template String @default("default") // default, landing, contact, etc.

  // SEO fields
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[] @default([])
  ogImage        String?

  // Publishing
  publishedAt DateTime?

  // Relations
  createdBy String? @db.ObjectId
  updatedBy String? @db.ObjectId

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([status])
}

// Navigation Menus
model Menu {
  id       String       @id @default(auto()) @map("_id") @db.ObjectId
  name     String       // Display name (e.g., "Main Menu", "Footer Links")
  location MenuLocation @unique // One menu per location
  isActive Boolean      @default(true)

  // Relations
  items MenuItem[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

// Menu Items (Hierarchical)
model MenuItem {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  menuId String @db.ObjectId
  menu   Menu   @relation(fields: [menuId], references: [id], onDelete: Cascade)

  // Item details
  label    String
  url      String  // Can be internal (/about) or external (https://...)
  icon     String? // Icon name or URL
  order    Int     @default(0)
  isActive Boolean @default(true)

  // Target
  openInNewTab Boolean @default(false)

  // Hierarchical structure
  parentId String?    @db.ObjectId
  parent   MenuItem?  @relation("MenuItemHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children MenuItem[] @relation("MenuItemHierarchy")

  // Permissions (optional)
  requiredRole String? // USER, ADMIN, etc.

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([menuId, order])
  @@index([parentId])
  @@map("menu_items")
}

// ============================================
// SETTINGS & FORMS (Sprint 2.3)
// ============================================

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

model Setting {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  key         String      @unique
  value       String      // Stored as string, parsed based on type
  type        SettingType @default(STRING)
  category    String      @default("general")
  label       String      // Human-readable label
  description String?     // Help text
  isPublic    Boolean     @default(false) // Can be accessed via public API
  validation  String?     // JSON schema for validation
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([category])
  @@index([isPublic])
  @@map("settings")
}

enum FormStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model Form {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  slug              String          @unique
  description       String?
  fields            String          // JSON array of field definitions
  status            FormStatus      @default(ACTIVE)
  notificationEmail String?         // Email to send submissions to
  successMessage    String?         // Message shown after submission  
  redirectUrl       String?         // Redirect after submission
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  submissions FormSubmission[]

  @@index([status])
  @@map("forms")
}

enum SubmissionStatus {
  NEW
  READ
  PROCESSED
  SPAM
}

model FormSubmission {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  formId    String           @db.ObjectId
  data      String           // JSON object with submitted data
  status    SubmissionStatus @default(NEW)
  ip        String?
  userAgent String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId, createdAt])
  @@index([status])
  @@map("form_submissions")
}

// ============================================
// SECURITY & AUDIT (Phase 3)
// ============================================

enum LoginStatus {
  SUCCESS
  FAILED
  BLOCKED
}

model LoginHistory {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  userId     String?     @db.ObjectId
  email      String
  status     LoginStatus
  failReason String?
  ip         String
  userAgent  String?
  createdAt  DateTime    @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([email, createdAt])
  @@index([status, createdAt])
  @@index([ip, createdAt])
  @@map("login_history")
}

enum SecurityEventType {
  BRUTE_FORCE
  SUSPICIOUS_LOGIN
  UNAUTHORIZED_ACCESS
  ACCOUNT_LOCKOUT
  PASSWORD_RESET
  PRIVILEGE_ESCALATION
  DATA_BREACH_ATTEMPT
}

enum SecurityEventSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model SecurityEvent {
  id          String                @id @default(auto()) @map("_id") @db.ObjectId
  type        SecurityEventType
  severity    SecurityEventSeverity
  userId      String?               @db.ObjectId
  ip          String
  userAgent   String?
  description String
  data        String?               // JSON metadata
  resolved    Boolean               @default(false)
  resolvedBy  String?               @db.ObjectId
  resolvedAt  DateTime?
  createdAt   DateTime              @default(now())

  user     User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  resolver User? @relation("ResolvedEvents", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([type, createdAt])
  @@index([severity, resolved])
  @@index([userId, createdAt])
  @@index([ip, createdAt])
  @@map("security_events")
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  IMPORT
}

model ActivityLog {
  id         String         @id @default(auto()) @map("_id") @db.ObjectId
  userId     String         @db.ObjectId
  action     ActivityAction
  resource   String
  resourceId String?
  changes    String?        // JSON diff
  ip         String
  userAgent  String?
  createdAt  DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([resource, action, createdAt])
  @@index([createdAt])
  @@map("activity_logs")
}

enum BlockType {
  TEMPORARY
  PERMANENT
}

model IPBlacklist {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  ip        String    @unique
  type      BlockType
  reason    String
  blockedBy String?   @db.ObjectId
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  blocker User? @relation(fields: [blockedBy], references: [id], onDelete: SetNull)

  @@index([expiresAt])
  @@map("ip_blacklist")
}
