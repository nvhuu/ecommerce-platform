generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  SUPERADMIN
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  COD
  BANK_TRANSFER
  MOMO
  VNPAY
  STRIPE
  PAYPAL
}

model User {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  email    String @unique
  password String
  role     Role   @default(USER)

  // Profile fields
  firstName   String?
  lastName    String?
  phone       String?
  avatar      String?
  dateOfBirth DateTime?

  // Loyalty & Points
  loyaltyPoints     Int @default(0)
  totalPointsEarned Int @default(0)

  // Security fields
  lastLoginAt         DateTime?
  lastLoginIp         String?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Preferences
  emailVerified         Boolean @default(false)
  emailOptIn            Boolean @default(true)
  pushOptIn             Boolean @default(true)
  marketingConsent      Boolean @default(false)
  dataProcessingConsent Boolean @default(false)
  preferredLanguage     String  @default("vi")
  preferredCurrency     String  @default("VND")

  // Timestamps
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  orders              Order[]
  createdCategories   Category[]     @relation("CategoryCreator")
  updatedCategories   Category[]     @relation("CategoryUpdater")
  deletedCategories   Category[]     @relation("CategoryDeleter")
  createdProducts     Product[]      @relation("ProductCreator")
  updatedProducts     Product[]      @relation("ProductUpdater")
  deletedProducts     Product[]      @relation("ProductDeleter")
  createdOrders       Order[]        @relation("OrderCreator")
  updatedOrders       Order[]        @relation("OrderUpdater")
  deletedOrders       Order[]        @relation("OrderDeleter")
  orderHistoryChanges OrderHistory[] @relation("OrderHistoryUser") // NEW
  orderNotesCreated   OrderNote[]    @relation("OrderNoteCreator") // NEW
  couponUsages      CouponUsage[]    @relation("UserCouponUsages") // NEW Sprint 1.3
  returns           Return[]         @relation("UserReturns") // NEW Sprint 1.3
  approvedReturns   Return[]         @relation("ReturnApprover") // NEW Sprint 1.3
  createdMedia        Media[]        @relation("MediaCreator")
  createdFolders      MediaFolder[]  @relation("FolderCreator")
  cart                Cart?
  reviews             Review[]
}

model Category {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  slug      String     @unique
  parentId  String?    @db.ObjectId
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  Category[] @relation("CategoryHierarchy")
  products  Product[]
  createdAt DateTime   @default(now())
  createdBy String?    @db.ObjectId
  creator   User?      @relation("CategoryCreator", fields: [createdBy], references: [id])
  updatedAt DateTime   @updatedAt
  updatedBy String?    @db.ObjectId
  updater   User?      @relation("CategoryUpdater", fields: [updatedBy], references: [id])
  deletedAt DateTime?
  deletedBy String?    @db.ObjectId
  deleter   User?      @relation("CategoryDeleter", fields: [deletedBy], references: [id])
}

model Product {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String @unique
  description String

  // Pricing & Inventory
  price    Float
  stock    Int   @default(0)
  reserved Int   @default(0) // Reserved for pending orders

  // Product Info
  brand  String?
  sku    String?  @unique
  tags   String[] @default([])
  images String[] @default([])

  // Status & Features
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Cached aggregates
  averageRating Float @default(0)
  reviewCount   Int   @default(0)

  // SEO fields
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[] @default([])
  ogImage        String?

  // Relations
  categoryId            String                 @db.ObjectId
  category              Category               @relation(fields: [categoryId], references: [id])
  orderItems            OrderItem[]
  cartItems             CartItem[]
  reviews               Review[]
  variants              ProductVariant[] // NEW: Product variants
  inventoryTransactions InventoryTransaction[] //NEW: Inventory tracking
  returnItems           ReturnItem[]     @relation("ProductReturnItems") // NEW Sprint 1.3

  // Timestamps
  createdAt DateTime  @default(now())
  createdBy String?   @db.ObjectId
  creator   User?     @relation("ProductCreator", fields: [createdBy], references: [id])
  updatedAt DateTime  @updatedAt
  updatedBy String?   @db.ObjectId
  updater   User?     @relation("ProductUpdater", fields: [updatedBy], references: [id])
  deletedAt DateTime?
  deletedBy String?   @db.ObjectId
  deleter   User?     @relation("ProductDeleter", fields: [deletedBy], references: [id])
}

enum InventoryTransactionType {
  PURCHASE // Stock in
  SALE // Stock out
  RETURN // Customer return
  ADJUSTMENT // Manual adjustment
  DAMAGE // Damaged goods
  RESERVED // Reserved for order
  RELEASED // Released reservation
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
}

enum ShipmentStatus {
  PREPARING
  READY_TO_SHIP
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED_DELIVERY
  RETURNED
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum ReturnStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum ReturnReason {
  DEFECTIVE
  WRONG_ITEM
  NOT_AS_DESCRIBED
  CHANGED_MIND
  OTHER
}

model ProductVariant {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Variant details
  sku        String @unique
  name       String // e.g. "Red - Large", "128GB"
  attributes Json // {color: "red", size: "L"} or {storage: "128GB"}

  // Pricing & Stock
  price    Float
  stock    Int     @default(0)
  reserved Int     @default(0)
  isActive Boolean @default(true)

  // Relations
  inventoryTransactions InventoryTransaction[]
  cartItems             CartItem[]             @relation("VariantCartItems")
  orderItems            OrderItem[]            @relation("VariantOrderItems")
  returnItems           ReturnItem[]     @relation("VariantReturnItems") // NEW Sprint 1.3

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InventoryTransaction {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Product/Variant
  productId String          @db.ObjectId
  product   Product         @relation(fields: [productId], references: [id])
  variantId String?         @db.ObjectId
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  // Transaction details
  type      InventoryTransactionType
  quantity  Int // Positive for in, negative for out
  reference String? // Order ID, PO number, etc.
  note      String?

  // Timestamps
  createdAt DateTime @default(now())
  createdBy String?  @db.ObjectId
}

model Order {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // Pricing breakdown
  subtotal       Float
  discountAmount Float @default(0)
  shippingFee    Float @default(0)
  tax            Float @default(0)
  totalAmount    Float

  // Status
  status OrderStatus @default(PENDING)

  // Payment & Shipping
  paymentMethod   PaymentMethod?
  shippingAddress Json? // Structured: {fullName, phone, address, city, country, postalCode, isDefault}

  // Relations
  items     OrderItem[]
  history   OrderHistory[] @relation("OrderHistoryEntries") // NEW: Status tracking
  notes     OrderNote[]    @relation("OrderNotes") // NEW: Internal notes  
  payments  Payment[]      @relation("OrderPayments") // NEW: Payment records
  shipments Shipment[]     @relation("OrderShipments") // NEW: Shipping tracking
  couponUsages CouponUsage[] @relation("OrderCouponUsages") // NEW Sprint 1.3
  returns      Return[]      @relation("OrderReturns") // NEW Sprint 1.3

  // Timestamps
  createdAt DateTime  @default(now())
  createdBy String?   @db.ObjectId
  creator   User?     @relation("OrderCreator", fields: [createdBy], references: [id])
  updatedAt DateTime  @updatedAt
  updatedBy String?   @db.ObjectId
  updater   User?     @relation("OrderUpdater", fields: [updatedBy], references: [id])
  deletedAt DateTime?
  deletedBy String?   @db.ObjectId
  deleter   User?     @relation("OrderDeleter", fields: [deletedBy], references: [id])
}

model OrderItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String  @db.ObjectId
  order     Order   @relation(fields: [orderId], references: [id])
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])

  // Variant support
  variantId String?         @db.ObjectId
  variant   ProductVariant? @relation("VariantOrderItems", fields: [variantId], references: [id])

  quantity Int
  price    Float // Price snapshot at time of order
}

// NEW: Order status change tracking
model OrderHistory {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  orderId String @db.ObjectId
  order   Order  @relation("OrderHistoryEntries", fields: [orderId], references: [id])

  fromStatus OrderStatus?
  toStatus   OrderStatus
  note       String?

  changedAt DateTime @default(now())
  changedBy String?  @db.ObjectId
  user      User?    @relation("OrderHistoryUser", fields: [changedBy], references: [id])

  @@index([orderId, changedAt])
}

// NEW: Internal order notes
model OrderNote {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  orderId String @db.ObjectId
  order   Order  @relation("OrderNotes", fields: [orderId], references: [id])

  note       String
  isInternal Boolean @default(true) // Internal vs customer-visible

  createdAt DateTime @default(now())
  createdBy String   @db.ObjectId
  user      User     @relation("OrderNoteCreator", fields: [createdBy], references: [id])
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

// NEW: Payment transactions
model Payment {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  orderId String @db.ObjectId
  order   Order  @relation("OrderPayments", fields: [orderId], references: [id])

  amount   Float
  currency String        @default("VND")
  method   PaymentMethod
  status   PaymentStatus @default(PENDING)

  // Gateway info
  gatewayTransactionId String? // External payment gateway ID
  gatewayResponse      Json? // Full response from gateway

  // Refund tracking
  refundedAmount Float     @default(0)
  refundedAt     DateTime?
  refundReason   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([gatewayTransactionId])
}

// NEW: Shipment tracking  
model Shipment {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  orderId String @db.ObjectId
  order   Order  @relation("OrderShipments", fields: [orderId], references: [id])

  carrier        String // Giao Hàng Nhanh, Giao Hàng Tiết Kiệm, etc.
  trackingNumber String?
  status         ShipmentStatus @default(PREPARING)

  // Shipping details
  shippingAddress   Json // Same structure as Order.shippingAddress
  estimatedDelivery DateTime?
  actualDelivery    DateTime?

  // Tracking history
  trackingHistory Json[] @default([]) // [{status, timestamp, location, note}]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([trackingNumber])
}

// Coupon/Promotion system
model Coupon {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  code           String      @unique
  type           CouponType
  value          Float
  minOrderAmount Float?
  maxDiscount    Float?
  usageLimit     Int?
  usageCount     Int         @default(0)
  perUserLimit   Int?
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean     @default(true)
  
  usages CouponUsage[]
  
  createdAt DateTime  @default(now())
  createdBy String?   @db.ObjectId
  updatedAt DateTime  @updatedAt
}

model CouponUsage {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  couponId       String   @db.ObjectId
  coupon         Coupon   @relation(fields: [couponId], references: [id])
  userId         String   @db.ObjectId
  user           User     @relation("UserCouponUsages", fields: [userId], references: [id])
  orderId        String   @db.ObjectId
  order          Order    @relation("OrderCouponUsages", fields: [orderId], references: [id])
  
  discountAmount Float
  usedAt         DateTime @default(now())
  
  @@index([couponId, userId])
}

// Return/Refund system
model Return {
  id     String       @id @default(auto()) @map("_id") @db.ObjectId
  orderId String      @db.ObjectId
  order   Order       @relation("OrderReturns", fields: [orderId], references: [id])
  userId  String      @db.ObjectId
  user    User        @relation("UserReturns", fields: [userId], references: [id])
  
  status ReturnStatus @default(PENDING)
  reason ReturnReason
  note   String?
  
  items ReturnItem[]
  
  totalRefund Float
  
  approvedAt DateTime?
  approvedBy String?   @db.ObjectId
  approver   User?     @relation("ReturnApprover", fields: [approvedBy], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([orderId, userId])
}

model ReturnItem {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  returnId String @db.ObjectId
  return   Return @relation(fields: [returnId], references: [id])
  
  productId String  @db.ObjectId
  product   Product @relation("ProductReturnItems", fields: [productId], references: [id])
  
  variantId String?         @db.ObjectId
  variant   ProductVariant? @relation("VariantReturnItems", fields: [variantId], references: [id])
  
  quantity     Int
  refundAmount Float
  reason       String?
}

model MediaFolder {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  parentId  String?       @db.ObjectId
  parent    MediaFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  MediaFolder[] @relation("FolderHierarchy")
  media     Media[]
  createdAt DateTime      @default(now())
  createdBy String?       @db.ObjectId
  creator   User?         @relation("FolderCreator", fields: [createdBy], references: [id])
}

model Media {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  fileName String
  fileType String // MIME type: image/jpeg, video/mp4, etc.
  fileSize Int // Size in bytes
  fileUrl  String

  // Metadata
  altText String? // SEO alt text
  title   String? // Image title
  caption String? // Description/caption
  tags    String[] @default([]) // Searchable tags

  // Dimensions (for images/videos)
  width    Int?
  height   Int?
  duration Int? // Video duration in seconds

  // Relations
  folderId String?      @db.ObjectId
  folder   MediaFolder? @relation(fields: [folderId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  createdBy String?  @db.ObjectId
  creator   User?    @relation("MediaCreator", fields: [createdBy], references: [id])
  updatedAt DateTime @updatedAt
}

model Cart {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  userId    String     @unique @db.ObjectId
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  cartId    String  @db.ObjectId
  cart      Cart    @relation(fields: [cartId], references: [id])
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])

  // Variant support
  variantId String?         @db.ObjectId
  variant   ProductVariant? @relation("VariantCartItems", fields: [variantId], references: [id])

  quantity Int
}

model Review {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  rating  Int // 1-5 stars
  comment String?
  images  String[] @default([]) // Review photos

  // Verification & Moderation
  verified    Boolean      @default(false) // Purchase verified
  status      ReviewStatus @default(PENDING)
  isModerated Boolean      @default(false)
  reportCount Int          @default(0)

  // Helpfulness votes
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)

  // Relations
  userId    String  @db.ObjectId
  user      User    @relation(fields: [userId], references: [id])
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
